<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriTrack - Dein Ernährungs-Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel für JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (Core and React UMD Build) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

        /* Animationen */
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Lucide Icons aus dem globalen Objekt extrahieren
        const { 
            Plus, Trash2, Utensils, Flame, Search, Calendar: CalendarIcon, 
            Database, Upload, CheckCircle2, X, Settings, 
            ChevronLeft, ChevronRight, Save, Calculator, ChevronDown, 
            Sparkles, Loader2, BrainCircuit, Copy, Pencil
        } = Lucide;

        // --- Konfiguration ---
        const apiKey = ""; // Wird zur Laufzeit bereitgestellt
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const App = () => {
            // --- Hilfsfunktionen ---
            const getTodayStr = () => new Date().toISOString().split('T')[0];
            const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('de-DE', { weekday: 'long' });
            const getDayIndex = (dateStr) => new Date(dateStr).getDay();

            const wochentage = [
                { id: 1, name: 'Montag' }, { id: 2, name: 'Dienstag' }, { id: 3, name: 'Mittwoch' },
                { id: 4, name: 'Donnerstag' }, { id: 5, name: 'Freitag' }, { id: 6, name: 'Samstag' }, { id: 0, name: 'Sonntag' },
            ];

            // --- State ---
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('nutri_logs_final')) || []);
            const [foodDatabase, setFoodDatabase] = useState(() => JSON.parse(localStorage.getItem('nutri_db_final')) || []);
            const [goals, setGoals] = useState(() => {
                const saved = localStorage.getItem('nutri_goals_final');
                if (saved) return JSON.parse(saved);
                const def = { calories: 2192, protein: 150, carbs: 250, fat: 60, fiber: 30 };
                const initial = {};
                [0,1,2,3,4,5,6].forEach(d => initial[d] = { ...def });
                return initial;
            });
            
            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [activeTab, setActiveTab] = useState('diary'); 
            const [showSettings, setShowSettings] = useState(false);
            const [settingsDay, setSettingsDay] = useState(getDayIndex(getTodayStr())); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [notification, setNotification] = useState(null);
            const [isImporting, setIsImporting] = useState(false);
            const [viewMonth, setViewMonth] = useState(new Date());

            const [searchQuery, setSearchQuery] = useState('');
            const [selectedFood, setSelectedFood] = useState(null); 
            const [editingLog, setEditingLog] = useState(null);
            const [amount, setAmount] = useState(100);
            const [calcMode, setCalcMode] = useState('per100g'); 
            const [quickTrack, setQuickTrack] = useState({ name: '', protein: '', fat: '', carbs: '', fiber: '', kcal: '' });

            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiSuggestions, setAiSuggestions] = useState(null);
            const fileInputRef = useRef(null);

            // --- Persistence ---
            useEffect(() => localStorage.setItem('nutri_logs_final', JSON.stringify(logs)), [logs]);
            useEffect(() => localStorage.setItem('nutri_db_final', JSON.stringify(foodDatabase)), [foodDatabase]);
            useEffect(() => localStorage.setItem('nutri_goals_final', JSON.stringify(goals)), [goals]);

            // --- Berechnungen ---
            const currentDayIndex = useMemo(() => getDayIndex(selectedDate), [selectedDate]);
            const currentDayGoals = useMemo(() => goals[currentDayIndex], [goals, currentDayIndex]);
            const dailyLogs = useMemo(() => logs.filter(log => log.date === selectedDate), [logs, selectedDate]);

            const totals = useMemo(() => dailyLogs.reduce((acc, curr) => ({
                calories: acc.calories + (curr.calories * (curr.amount / 100)),
                protein: acc.protein + (curr.protein * (curr.amount / 100)),
                carbs: acc.carbs + (curr.carbs * (curr.amount / 100)),
                fat: acc.fat + (curr.fat * (curr.amount / 100)),
                fiber: acc.fiber + ((curr.fiber || 0) * (curr.amount / 100)),
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 }), [dailyLogs]);

            const filteredDB = useMemo(() => {
                if (searchQuery.length < 2) return [];
                return foodDatabase.filter(item => item.name.toLowerCase().includes(searchQuery.toLowerCase())).slice(0, 30);
            }, [searchQuery, foodDatabase]);

            const loggedDays = useMemo(() => {
                const days = new Set();
                logs.forEach(log => days.add(log.date));
                return days;
            }, [logs]);

            // --- Gemini API Integration ---
            const callGemini = async (prompt, isJson = true) => {
                const payload = { 
                    contents: [{ parts: [{ text: prompt }] }], 
                    generationConfig: isJson ? { responseMimeType: "application/json" } : {} 
                };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            const handleAiAnalyzeRecipe = async () => {
                if (!quickTrack.name) return showToast("Bitte gib Text ein.");
                setIsAiLoading(true);
                try {
                    const result = await callGemini(`Analysiere Rezept oder Zutaten: "${quickTrack.name}". Schätze Nährwerte pro 100g oder gesamt. JSON: { "name": string, "kcal": number, "protein": number, "fat": number, "carbs": number, "fiber": number, "isPer100g": boolean }. Nutze deutsche Bezeichnungen.`);
                    const parsed = JSON.parse(result);
                    setQuickTrack({ 
                        name: parsed.name, 
                        kcal: parsed.kcal.toString(), 
                        protein: parsed.protein.toString(), 
                        fat: parsed.fat.toString(), 
                        carbs: parsed.carbs.toString(), 
                        fiber: parsed.fiber.toString() 
                    });
                    setCalcMode(parsed.isPer100g ? 'per100g' : 'total');
                    showToast("KI-Analyse erfolgreich! ✨");
                } catch (e) { showToast("Fehler bei Analyse."); } finally { setIsAiLoading(false); }
            };

            const handleAiSuggestMeal = async () => {
                setIsAiLoading(true);
                const rem = { kcal: currentDayGoals.calories - totals.calories, p: currentDayGoals.protein - totals.protein, c: currentDayGoals.carbs - totals.carbs, f: currentDayGoals.fat - totals.fat };
                try {
                    const result = await callGemini(`Tag: ${getDayName(selectedDate)}. Verbleibend: ${Math.round(rem.kcal)}kcal, ${Math.round(rem.p)}g P, ${Math.round(rem.c)}g C, ${Math.round(rem.f)}g F. Schlage 3 Mahlzeiten vor als JSON: { "suggestions": [{ "title": string, "desc": string, "macros": string }] }`);
                    setAiSuggestions(JSON.parse(result).suggestions);
                } catch (e) { showToast("Vorschläge fehlgeschlagen."); } finally { setIsAiLoading(false); }
            };

            // --- Mahlzeiten-Handlers ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImporting(true);
                const reader = new FileReader();
                reader.onload = (event) => {
                    const rows = event.target.result.split(/\r?\n/);
                    const header = rows[0].split(';');
                    const f = (s) => header.findIndex(h => h.toLowerCase().includes(s.toLowerCase()));
                    const i = { n: f('Lebensmittelbezeichnung'), k: f('Energie'), p: f('Protein'), f: f('Fett'), c: f('Kohlenhydrate'), b: f('Ballaststoffe') };
                    const data = rows.slice(1).map((r, idx) => {
                        const c = r.split(';'); if (c.length < 5 || !c[i.n]) return null;
                        const cv = (v) => v ? parseFloat(v.replace(/"/g, '').replace(',', '.')) || 0 : 0;
                        return { id: `bls-${idx}`, name: c[i.n].replace(/"/g, ''), calories: cv(c[i.k]), protein: cv(c[i.p]), fat: cv(c[i.f]), carbs: cv(c[i.c]), fiber: cv(c[i.b]) };
                    }).filter(x => x);
                    setFoodDatabase(data); setIsImporting(false); showToast(`${data.length} Lebensmittel geladen!`);
                };
                reader.readAsText(file);
            };

            const addLogEntry = (fData, g) => {
                setLogs([{ ...fData, id: Date.now(), amount: g, date: selectedDate, timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) }, ...logs]);
                resetAddState(); showToast("Eintrag hinzugefügt!");
            };

            const updateLogEntry = (logId, newAmount) => {
                setLogs(logs.map(log => log.id === logId ? { ...log, amount: newAmount } : log));
                setEditingLog(null); setAmount(100); showToast("Erfolgreich aktualisiert!");
            };

            const updateMacroGoal = (dayIdx, key, value) => {
                const val = parseInt(value) || 0;
                const newDayGoals = { ...goals[dayIdx], [key]: val };
                if (['protein', 'carbs', 'fat'].includes(key)) {
                    // Berechnung: P*4.1 + C*4.1 + F*9.3
                    newDayGoals.calories = Math.round((newDayGoals.protein * 4.1) + (newDayGoals.carbs * 4.1) + (newDayGoals.fat * 9.3));
                }
                setGoals({ ...goals, [dayIdx]: newDayGoals });
            };

            const copyToAllDays = (sourceDayIdx) => {
                const sourceData = { ...goals[sourceDayIdx] };
                const newGoals = {};
                [0,1,2,3,4,5,6].forEach(d => newGoals[d] = { ...sourceData });
                setGoals(newGoals);
                showToast(`Ziele von ${wochentage.find(t => t.id === sourceDayIdx).name} kopiert!`);
            };

            const handleQuickTrack = (e) => {
                e.preventDefault(); if (!quickTrack.name || !quickTrack.kcal) return;
                const g = parseFloat(amount) || 100;
                const f = calcMode === 'total' ? (100 / g) : 1;
                addLogEntry({ 
                    name: quickTrack.name, 
                    calories: parseFloat(quickTrack.kcal)*f, 
                    protein: parseFloat(quickTrack.protein||0)*f, 
                    fat: parseFloat(quickTrack.fat||0)*f, 
                    carbs: parseFloat(quickTrack.carbs||0)*f, 
                    fiber: parseFloat(quickTrack.fiber||0)*f 
                }, g);
            };

            const resetAddState = () => { 
                setShowAddModal(false); 
                setSelectedFood(null); 
                setEditingLog(null); 
                setSearchQuery(''); 
                setAmount(100); 
                setQuickTrack({ name: '', protein: '', fat: '', carbs: '', fiber: '', kcal: '' }); 
            };
            
            const showToast = (m) => { setNotification(m); setTimeout(() => setNotification(null), 3000); };

            // --- UI Komponenten ---
            const DashboardMacro = ({ label, val, target, color }) => (
                <div className={`bg-${color}-50 border border-${color}-100 rounded-2xl p-3 text-center`}>
                    <p className={`text-[9px] font-black uppercase text-${color}-600 mb-1`}>{label}</p>
                    <p className="font-bold text-slate-800 text-sm">{Math.round(val)}g</p>
                    <div className="w-full h-1 bg-white rounded-full mt-2 overflow-hidden">
                        <div className={`h-full bg-${color}-400 transition-all duration-500`} style={{ width: `${Math.min((val / target) * 100, 100)}%` }}></div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 pb-24 font-sans select-none">
                    {/* Header */}
                    <nav className="bg-white border-b sticky top-0 z-40 shadow-sm">
                        <div className="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-2 text-emerald-600 font-black text-xl tracking-tighter">
                                <Utensils size={24} strokeWidth={3}/> NutriTrack
                            </div>
                            <button onClick={() => { setSettingsDay(currentDayIndex); setShowSettings(true); }} className="p-2 text-slate-400 hover:text-emerald-600 transition-colors">
                                <Settings size={22}/>
                            </button>
                        </div>
                        {activeTab === 'diary' && (
                            <div className="max-w-md mx-auto px-4 py-2 flex justify-between items-center bg-slate-50/50 border-t">
                                <button onClick={() => setSelectedDate(d => { const date = new Date(d); date.setDate(date.getDate()-1); return date.toISOString().split('T')[0]; })} className="p-2">
                                    <ChevronLeft size={20} className="text-slate-400"/>
                                </button>
                                <div className="text-center">
                                    <p className="text-[10px] font-black text-emerald-600 uppercase tracking-widest">{getDayName(selectedDate)}</p>
                                    <p className="text-xs font-bold text-slate-600">
                                        {selectedDate === getTodayStr() ? 'Heute' : new Date(selectedDate).toLocaleDateString('de-DE', { day: '2-digit', month: 'short' })}
                                    </p>
                                </div>
                                <button onClick={() => setSelectedDate(d => { const date = new Date(d); date.setDate(date.getDate()+1); return date.toISOString().split('T')[0]; })} className="p-2">
                                    <ChevronRight size={20} className="text-slate-400"/>
                                </button>
                            </div>
                        )}
                    </nav>

                    {/* Navigation Tabs */}
                    <div className="max-w-md mx-auto px-4 mt-4 flex bg-slate-200/50 p-1.5 rounded-2xl gap-1">
                        {['diary', 'database', 'calendar'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} 
                                className={`flex-1 py-2.5 text-[11px] font-black uppercase rounded-xl transition-all ${activeTab === t ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>
                                {t === 'diary' ? 'Tagebuch' : t === 'database' ? 'DB' : 'Kalender'}
                            </button>
                        ))}
                    </div>

                    <main className="max-w-md mx-auto px-4 py-6">
                        {activeTab === 'diary' && (
                            <div className="space-y-6">
                                {/* AI Coach */}
                                {!aiSuggestions ? (
                                    <button onClick={handleAiSuggestMeal} disabled={isAiLoading} 
                                        className="w-full bg-white border border-emerald-100 rounded-[28px] p-5 flex items-center justify-between hover:shadow-md transition-all group">
                                        <div className="flex items-center gap-4">
                                            <div className="bg-emerald-50 p-3 rounded-2xl text-emerald-500 group-active:scale-90 transition-transform">
                                                {isAiLoading ? <Loader2 size={24} className="animate-spin" /> : <Sparkles size={24} />}
                                            </div>
                                            <div className="text-left font-bold text-sm">
                                                KI-Mahlzeiten Coach ✨
                                                <p className="text-[10px] font-normal text-slate-400 uppercase tracking-wider">Passend für deine Rest-Makros</p>
                                            </div>
                                        </div>
                                        <ChevronRight size={18} className="text-slate-200" />
                                    </button>
                                ) : (
                                    <div className="bg-white rounded-[32px] p-6 border border-emerald-100 animate-in fade-in slide-in-from-top-2">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-black text-sm uppercase text-emerald-600 flex items-center gap-2">
                                                <Sparkles size={16}/> Vorschläge
                                            </h4>
                                            <button onClick={() => setAiSuggestions(null)} className="p-1"><X size={18} className="text-slate-300"/></button>
                                        </div>
                                        <div className="space-y-3">
                                            {aiSuggestions.map((s, i) => (
                                                <div key={i} className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                                    <p className="text-xs font-black text-slate-800 uppercase mb-0.5">{s.title}</p>
                                                    <p className="text-[11px] text-slate-500 leading-relaxed mb-2">{s.desc}</p>
                                                    <p className="text-[10px] font-black text-emerald-600 bg-emerald-50 inline-block px-2 py-1 rounded-lg">{s.macros}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Main Stats */}
                                <section className="bg-white rounded-[40px] p-8 shadow-sm border border-slate-100 relative overflow-hidden">
                                    <div className="flex justify-between items-end mb-6 relative z-10">
                                        <div>
                                            <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">Rest-Energie</p>
                                            <h2 className="text-5xl font-black text-slate-800 tracking-tighter">
                                                {Math.round(currentDayGoals.calories - totals.calories)} <span className="text-lg font-medium text-slate-300">kcal</span>
                                            </h2>
                                        </div>
                                        <div className="text-right text-[10px] font-black text-slate-300 uppercase">Ziel: {currentDayGoals.calories}</div>
                                    </div>
                                    <div className="w-full h-4 bg-slate-100 rounded-full overflow-hidden mb-8 relative z-10">
                                        <div className={`h-full transition-all duration-1000 ease-out ${totals.calories > currentDayGoals.calories ? 'bg-rose-500' : 'bg-emerald-500'}`} 
                                            style={{ width: `${Math.min((totals.calories / currentDayGoals.calories) * 100, 100)}%` }}></div>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2 relative z-10">
                                        <DashboardMacro label="P" val={totals.protein} target={currentDayGoals.protein} color="blue" />
                                        <DashboardMacro label="F" val={totals.fat} target={currentDayGoals.fat} color="rose" />
                                        <DashboardMacro label="C" val={totals.carbs} target={currentDayGoals.carbs} color="amber" />
                                        <DashboardMacro label="B" val={totals.fiber} target={currentDayGoals.fiber} color="emerald" />
                                    </div>
                                </section>

                                {/* Mahlzeiten Liste */}
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center px-2">
                                        <h3 className="font-black text-slate-800 text-lg">Heutige Mahlzeiten</h3>
                                        <button onClick={() => setShowAddModal(true)} className="bg-emerald-600 text-white w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-100 active:scale-90 transition-transform">
                                            <Plus size={24} strokeWidth={3}/>
                                        </button>
                                    </div>
                                    {dailyLogs.length === 0 ? (
                                        <div className="bg-white rounded-[32px] p-16 text-center border-dashed border-2 border-slate-200 text-slate-300 italic">
                                            Noch nichts getrackt für diesen Tag
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {dailyLogs.map(item => (
                                                <div key={item.id} className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center group animate-in fade-in slide-in-from-bottom-2">
                                                    <div className="flex-1">
                                                        <h4 className="font-black text-slate-800 text-sm line-clamp-1 mb-1">{item.name}</h4>
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-[11px] font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-lg">{item.amount}g</span>
                                                            <span className="text-[11px] text-slate-400 font-bold uppercase tracking-tight">{Math.round(item.calories * (item.amount/100))} kcal</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1 ml-4">
                                                        <button onClick={() => { setEditingLog(item); setAmount(item.amount); }} className="p-2 text-slate-200 hover:text-emerald-500 transition-colors">
                                                            <Pencil size={18}/>
                                                        </button>
                                                        <button onClick={() => setLogs(logs.filter(l => l.id !== item.id))} className="p-2 text-slate-200 hover:text-rose-500 transition-colors">
                                                            <Trash2 size={18}/>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'database' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h3 className="font-black text-lg">BLS 4.0 Datenbank</h3>
                                    <button onClick={() => fileInputRef.current.click()} className="text-xs font-black text-emerald-600 bg-emerald-50 px-4 py-2.5 rounded-2xl flex items-center gap-2">
                                        <Upload size={16}/> {isImporting ? 'Lädt...' : 'CSV Import'}
                                    </button>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={handleFileUpload} />
                                </div>
                                <div className="bg-white rounded-[40px] p-16 text-center border border-slate-100">
                                    <Database size={56} className="mx-auto mb-6 text-slate-100" />
                                    <p className="text-sm text-slate-400 font-medium">
                                        <span className="font-black text-slate-800">{foodDatabase.length}</span> Einträge in deiner Datenbank.
                                        <br/><br/>
                                        Lade deine BLS-CSV-Datei hoch, um Mahlzeiten blitzschnell zu finden.
                                    </p>
                                </div>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-[40px] p-8 shadow-sm border border-slate-100 animate-in fade-in zoom-in-95">
                                <div className="flex justify-between items-center mb-8">
                                    <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth()-1))} className="p-2 hover:bg-slate-50 rounded-full">
                                        <ChevronLeft size={24} className="text-slate-400"/>
                                    </button>
                                    <h3 className="font-black text-xl tracking-tight">{viewMonth.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}</h3>
                                    <button onClick={() => setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1))} className="p-2 hover:bg-slate-50 rounded-full">
                                        <ChevronRight size={24} className="text-slate-400"/>
                                    </button>
                                </div>
                                <div className="grid grid-cols-7 gap-2 text-center mb-4">
                                    {['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].map(d => (
                                        <div key={d} className="text-[10px] font-black text-slate-300 uppercase tracking-widest">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {(() => {
                                        const days = []; 
                                        const fD = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1).getDay(); 
                                        const pad = fD === 0 ? 6 : fD - 1; 
                                        const dIM = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 0).getDate();
                                        for(let i=0; i<pad; i++) days.push(null); 
                                        for(let d=1; d<=dIM; d++) days.push(new Date(viewMonth.getFullYear(), viewMonth.getMonth(), d));
                                        return days.map((date, i) => {
                                            if(!date) return <div key={i}/>;
                                            const ds = date.toISOString().split('T')[0];
                                            const isSelected = ds === selectedDate;
                                            const isToday = ds === getTodayStr();
                                            return (
                                                <button key={ds} onClick={() => { setSelectedDate(ds); setActiveTab('diary'); }} 
                                                    className={`aspect-square flex flex-col items-center justify-center rounded-2xl text-sm font-black relative transition-all active:scale-90
                                                        ${isSelected ? 'bg-emerald-600 text-white shadow-lg' : isToday ? 'bg-emerald-50 text-emerald-600' : 'text-slate-600 hover:bg-slate-50'}`}>
                                                    {date.getDate()}
                                                    {loggedDays.has(ds) && <div className={`w-1.5 h-1.5 rounded-full mt-1 ${isSelected ? 'bg-white' : 'bg-emerald-500 animate-pulse'}`}/>}
                                                </button>
                                            );
                                        });
                                    })()}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* MODAL: ADD / QUICKTRACK */}
                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-end justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-[48px] p-8 max-h-[90vh] overflow-y-auto custom-scrollbar animate-slide-up">
                                <div className="flex justify-between items-center mb-8 sticky top-0 bg-white pb-2 z-10">
                                    <h3 className="text-2xl font-black tracking-tight">Eintragen</h3>
                                    <button onClick={resetAddState} className="bg-slate-100 p-2.5 rounded-full hover:bg-slate-200 transition-colors">
                                        <X size={20} strokeWidth={3} />
                                    </button>
                                </div>
                                
                                {/* Datenbank Suche */}
                                <div className="relative mb-8">
                                    <div className="bg-slate-50 rounded-3xl flex items-center px-5 border border-slate-100 shadow-inner">
                                        <Search size={20} className="text-slate-400"/>
                                        <input type="text" placeholder="Datenbank durchsuchen..." className="w-full bg-transparent p-5 text-sm font-bold border-none outline-none placeholder:text-slate-300" 
                                            value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                                    </div>
                                    {filteredDB.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 mt-3 bg-white rounded-3xl shadow-2xl border border-slate-100 max-h-60 overflow-y-auto z-50">
                                            {filteredDB.map(f => (
                                                <button key={f.id} onClick={() => { setSelectedFood(f); setSearchQuery(''); }} className="w-full text-left p-5 border-b border-slate-50 hover:bg-emerald-50 transition-colors">
                                                    <p className="font-black text-slate-800 text-sm group-hover:text-emerald-600">{f.name}</p>
                                                    <p className="text-[10px] font-black text-slate-400 uppercase mt-1">100g: {f.calories} kcal | P: {f.protein}g</p>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="flex items-center gap-4 mb-8">
                                    <div className="h-px bg-slate-100 flex-1"></div>
                                    <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">ODER QUICKTRACK KI ✨</span>
                                    <div className="h-px bg-slate-100 flex-1"></div>
                                </div>

                                {/* Quicktrack Form */}
                                <form onSubmit={handleQuickTrack} className="space-y-6">
                                    <div className="relative">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block tracking-widest">Inhalt analysieren</label>
                                        <textarea placeholder="z.B. 2 Eier, eine Avocado, 100g Quark..." 
                                            className="w-full bg-slate-50 rounded-3xl p-5 text-sm min-h-[100px] outline-none border border-slate-100 focus:border-emerald-200 transition-all" 
                                            value={quickTrack.name} onChange={e => setQuickTrack({...quickTrack, name: e.target.value})}/>
                                        <button type="button" onClick={handleAiAnalyzeRecipe} disabled={isAiLoading}
                                            className="absolute right-4 bottom-4 bg-white shadow-lg border border-emerald-100 px-4 py-2 rounded-2xl text-[11px] font-black flex items-center gap-2 text-emerald-600 active:scale-95 transition-all">
                                            {isAiLoading ? <Loader2 size={14} className="animate-spin"/> : <BrainCircuit size={14}/>} 
                                            KI ANALYSE ✨
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block tracking-widest">Menge</label>
                                            <div className="relative">
                                                <input type="number" className="w-full bg-slate-50 rounded-2xl p-4 font-black text-emerald-600 outline-none border border-slate-100" 
                                                    value={amount} onChange={e => setAmount(e.target.value)}/>
                                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-black text-slate-300">g</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 block tracking-widest">Modus</label>
                                            <select className="w-full bg-slate-50 rounded-2xl p-4 font-black text-sm border border-slate-100 outline-none" 
                                                value={calcMode} onChange={e => setCalcMode(e.target.value)}>
                                                <option value="per100g">PRO 100G</option>
                                                <option value="total">GESAMTMENGE</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-5 gap-2"> 
                                        {[
                                            {k:'kcal',l:'kcal',c:'orange'},{k:'protein',l:'P',c:'blue'},
                                            {k:'fat',l:'F',c:'rose'},{k:'carbs',l:'C',c:'amber'},
                                            {k:'fiber',l:'B',c:'emerald'}
                                        ].map(f => (
                                            <div key={f.k}>
                                                <label className={`text-[9px] font-black text-${f.c}-500 uppercase block mb-1 text-center`}>{f.l}</label>
                                                <input type="number" step="0.1" className="w-full bg-slate-50 rounded-xl p-3 text-xs font-bold text-center border border-slate-50 outline-none" 
                                                    value={quickTrack[f.k]} onChange={e => setQuickTrack({...quickTrack, [f.k]: e.target.value})}/>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button type="submit" className="w-full bg-emerald-600 text-white font-black py-5 rounded-3xl shadow-xl shadow-emerald-100 hover:bg-emerald-700 active:scale-95 transition-all text-lg tracking-tight">
                                        Bestätigen & Tracken
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* MODAL: PORTION / EDIT */}
                    {(selectedFood || editingLog) && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[60] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[56px] p-10 shadow-2xl animate-in zoom-in-95 duration-200">
                                <h3 className="text-2xl font-black mb-8 leading-tight tracking-tight text-slate-800">{(selectedFood || editingLog).name}</h3>
                                <div className="bg-slate-50 rounded-[40px] p-8 text-center mb-8 border border-slate-100 shadow-inner">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3">Gewicht in Gramm</label>
                                    <input type="number" autoFocus className="w-full text-6xl font-black bg-transparent text-emerald-600 text-center outline-none border-none focus:ring-0" 
                                        value={amount} onChange={e => setAmount(Math.max(0, parseInt(e.target.value) || 0))}/>
                                </div>
                                <div className="grid grid-cols-4 gap-2 mb-10 text-center border-y border-slate-50 py-6">
                                    <div><p className="text-[9px] font-black uppercase text-slate-300 mb-1">kcal</p><p className="font-bold text-orange-600 text-sm">{Math.round((selectedFood || editingLog).calories * (amount/100))}</p></div>
                                    <div><p className="text-[9px] font-black uppercase text-slate-300 mb-1">P</p><p className="font-bold text-slate-700 text-sm">{Math.round((selectedFood || editingLog).protein * (amount/100) * 10)/10}g</p></div>
                                    <div><p className="text-[9px] font-black uppercase text-slate-300 mb-1">C</p><p className="font-bold text-slate-700 text-sm">{Math.round((selectedFood || editingLog).carbs * (amount/100) * 10)/10}g</p></div>
                                    <div><p className="text-[9px] font-black uppercase text-slate-300 mb-1">F</p><p className="font-bold text-slate-700 text-sm">{Math.round((selectedFood || editingLog).fat * (amount/100) * 10)/10}g</p></div>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => {setSelectedFood(null); setEditingLog(null);}} className="flex-1 bg-slate-50 text-slate-400 font-black py-5 rounded-[24px] active:scale-95 transition-all text-sm uppercase">Abbruch</button>
                                    <button onClick={() => editingLog ? updateLogEntry(editingLog.id, amount) : addLogEntry(selectedFood, amount)} 
                                        className="flex-[2] bg-emerald-600 text-white font-black py-5 rounded-[24px] shadow-xl shadow-emerald-100 active:scale-95 transition-all text-sm uppercase">Speichern</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: SETTINGS */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[48px] p-8 shadow-2xl animate-in zoom-in-95 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-8">
                                    <h3 className="text-2xl font-black tracking-tight">EINSTELLUNGEN</h3>
                                    <button onClick={() => setShowSettings(false)} className="bg-slate-50 p-2.5 rounded-full"><X size={20}/></button>
                                </div>
                                
                                <div className="flex overflow-x-auto gap-3 pb-6 mb-6 border-b border-slate-100 no-scrollbar">
                                    {wochentage.map(tag => (
                                        <button key={tag.id} onClick={() => setSettingsDay(tag.id)} 
                                            className={`px-5 py-3 rounded-2xl text-xs font-black whitespace-nowrap transition-all active:scale-95 ${settingsDay === tag.id ? 'bg-emerald-600 text-white shadow-lg' : 'bg-slate-50 text-slate-400'}`}>
                                            {tag.name}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-black text-slate-800 uppercase tracking-widest">{wochentage.find(t => t.id === settingsDay).name}</span>
                                        <button onClick={() => copyToAllDays(settingsDay)} className="text-[10px] font-black text-emerald-600 uppercase bg-emerald-50 px-4 py-2 rounded-xl active:scale-95 transition-all">
                                            <Copy size={12} className="inline mr-2"/> Für alle Tage
                                        </button>
                                    </div>
                                    
                                    <div className="bg-emerald-50 p-6 rounded-[32px] border border-emerald-100 shadow-inner">
                                        <label className="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-2 block">Berechnetes Ziel</label>
                                        <div className="text-4xl font-black text-emerald-700">{goals[settingsDay].calories} <span className="text-sm font-medium opacity-50">kcal</span></div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4"> 
                                        {[
                                            {k:'protein',l:'Protein',c:'blue'},{k:'carbs',l:'Carbs',c:'amber'},
                                            {k:'fat',l:'Fett',c:'rose'},{k:'fiber',l:'Ballast',c:'slate'}
                                        ].map(m => (
                                            <div key={m.k}>
                                                <label className={`text-[9px] font-black text-${m.c}-600 uppercase mb-2 block tracking-widest ml-1`}>{m.l} (g)</label>
                                                <input type="number" className="w-full bg-slate-50 rounded-2xl p-4 font-black outline-none border border-slate-50" 
                                                    value={goals[settingsDay][m.k]} onChange={e => updateMacroGoal(settingsDay, m.k, e.target.value)}/>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button onClick={() => {setShowSettings(false); showToast('Einstellungen gespeichert!');}} 
                                        className="w-full bg-emerald-600 text-white font-black py-5 rounded-[24px] mt-6 shadow-xl shadow-emerald-100 active:scale-95 transition-all uppercase tracking-widest text-sm">
                                        Planung Fertigstellen
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Notification Toast */}
                    {notification && (
                        <div className="fixed top-12 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-[24px] text-sm font-black flex items-center gap-4 z-[100] animate-in fade-in slide-in-from-top-6 shadow-2xl">
                            <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                            {notification}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>